(function(){"use strict";const p=(e,t)=>Math.floor(e/3)*3+Math.floor(t/3),j=(e,t)=>{const o=Math.floor(e/3)*3,r=e%3*3,n=Math.floor(t/3),s=t%3;return[o+n,r+s]},S=e=>{const t=o=>o!==void 0?o:0;return e.map(o=>o.map(t).join(",")).join("|")},k=e=>{const t=o=>o==="0"?void 0:parseInt(o);return e.split("|").map(o=>o.split(",").map(t))},w=e=>{const t=new Array(9).fill(511),o=new Array(9).fill(511),r=new Array(9).fill(511);for(let s=0;s<9;s++)for(let i=0;i<9;i++){const c=e[s][i];if(c){const l=~(1<<c-1);t[s]&=l,o[i]&=l,r[p(s,i)]&=l}}const n=new Array(9).fill(0).map(s=>new Array(9).fill(511));for(let s=0;s<9;s++)for(let i=0;i<9;i++)n[s][i]&=t[s],n[s][i]&=o[i],n[s][i]&=r[p(s,i)];return n},_=e=>{let t=0;for(;e>0;)t+=1,e=e&e-1;return t},d=(e,t)=>{let o=0;for(;t>=0;)o++,(e&1)===1&&t--,e=e>>1;return o},h=(e,t)=>{const o=[];for(let r=0;r<9;r++)for(let n=0;n<9;n++)if(e[r][n]===void 0){const s=_(t[r][n]);o.push([r,n,s,t[r][n]])}return v(o),o.sort((r,n)=>r[2]-n[2]),o},M=(e,t,o,r)=>{const n=1<<o-1,s=[],i=p(e,t);for(let c=0;c<9;c++)c!==t&&(r[e][c]&n)>0&&(r[e][c]&=~n,s.push([e,c,n]));for(let c=0;c<9;c++)c!==e&&(r[c][t]&n)>0&&(r[c][t]&=~n,s.push([c,t,n]));for(let c=0;c<9;c++){const[l,a]=j(i,c);l===e&&a===t||(r[l][a]&n)>0&&(r[l][a]&=~n,s.push([l,a,n]))}return s},y=(e,t)=>{for(const o of e){const[r,n,s]=o;t[r][n]|=s}},v=e=>{for(let t=e.length-1;t>0;t--){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}},A=e=>new Promise(t=>{setTimeout(t,e)}),g=async(e,t,o,r,n)=>{const s=h(e,t);if(s.length===0)return!0;if(s[0][2]===0)return!1;const[i,c,l,a]=s[0],f=new Array(l).fill(0).map((m,u)=>u);v(f);for(const m of f){const u=d(a,m);e[i][c]=u,o&&postMessage({event:"setNumber",number:u,row:i,col:c});const F=M(i,c,u,t);if(o&&(postMessage({event:"updatePossible",possibilities:t}),await A(r)),await g(e,t,o,r,n))return!0;y(F,t)}return e[i][c]=void 0,o&&(postMessage({event:"setNumber",number:void 0,row:i,col:c}),await A(n)),!1},x=(e,t,o)=>{const r=w(e);postMessage({event:"updatePossible",possibilities:r}),g(e,r,!0,t,o).then(n=>{postMessage(n?{event:"success"}:{event:"failed",error:"Failed to find a solution"})})},P=(e,t)=>{const o=h(e,t);if(o.length===0)return 1;if(o[0][2]===0)return 0;let r=0;const[n,s,i,c]=o[0],l=new Array(i).fill(0).map((a,f)=>f);for(const a of l){const f=d(c,a);e[n][s]=f;const m=M(n,s,f,t);r+=P(e,t),y(m,t)}return e[n][s]=void 0,r},B=e=>{const t=w(e);return P(e,t)},b=async(e,t=0)=>{const o=new Array(9).fill(0).map(s=>new Array(9).fill(void 0)),r=w(o);await g(o,r,!1,0,0);const n=new Array(81).fill(0).map((s,i)=>i);v(n);for(let s=0;s<e;s++){const i=n.pop();if(!i)return t<=20?await b(e,t+1):!1;const c=Math.floor(i/9),l=i%9,a=o[c][l];o[c][l]=void 0;const f=o.map(m=>m.map(u=>u));B(f)>1&&(o[c][l]=a,s--)}return postMessage({event:"success",board:S(o)}),!0},T=async e=>{let t=5;for(;t>0;){if(await b(e))return;t--}postMessage({event:"failed",error:"Failed to generate board."})};onmessage=e=>{const t=e.data;switch(t.type){case"solve":{const{board:o,forwardDelay:r,backDelay:n}=t;x(k(o),r,n);break}case"generate":{const{count:o}=t;T(o);break}}}})();
